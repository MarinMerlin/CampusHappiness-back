{"version":3,"sources":["../../mail/timer.js"],"names":["schedule","require","Models","mailer","id_generator","scheduler","scheduleJob","User","findAll","include","model","Group","then","users","forEach","data","sondage_id","dataValues","group","JourSondage","findOrCreate","where","date_emmission","Date","now","defaults","id","nombre_emission","spread","jourSondage","created","token","generateJwt","diff","lastMailDate","mailIntensity","update","increment","module","exports"],"mappings":";;AAAA,IAAMA,QAAQ,GAAGC,OAAO,CAAC,eAAD,CAAxB;;AACA,IAAMC,MAAM,GAAGD,OAAO,CAAC,oBAAD,CAAtB;;AACA,IAAME,MAAM,GAAGF,OAAO,CAAC,UAAD,CAAtB;;AACA,IAAMG,YAAY,GAAGH,OAAO,CAAC,+BAAD,CAA5B;;AAEA,IAAMI,SAAS,GAAG,SAAZA,SAAY,GAAY;AAC5BL,EAAAA,QAAQ,CAACM,WAAT,CAAqB,aAArB,EAAoC,YAAM;AACxCJ,IAAAA,MAAM,CAACK,IAAP,CAAYC,OAAZ,CAAoB;AAClBC,MAAAA,OAAO,EAAE,CACP;AACEC,QAAAA,KAAK,EAAER,MAAM,CAACS;AADhB,OADO;AADS,KAApB,EAMGC,IANH,CAMQ,UAACC,KAAD,EAAW;AACjBA,MAAAA,KAAK,CAACC,OAAN,CAAc,UAACC,IAAD,EAAU;AACtB,YAAMC,UAAU,GAAGD,IAAI,CAACE,UAAL,CAAgBC,KAAhB,CAAsBD,UAAtB,CAAiCD,UAApD;AACAd,QAAAA,MAAM,CAACiB,WAAP,CAAmBC,YAAnB,CAAgC;AAC9BC,UAAAA,KAAK,EAAE;AAAEC,YAAAA,cAAc,EAAEC,IAAI,CAACC,GAAL,EAAlB;AAA8BR,YAAAA,UAAU,EAAEA;AAA1C,WADuB;AAE9BS,UAAAA,QAAQ,EAAE;AAAEC,YAAAA,EAAE,EAAEtB,YAAY,EAAlB;AAAsBY,YAAAA,UAAU,EAAEA,UAAlC;AAA8CW,YAAAA,eAAe,EAAE;AAA/D;AAFoB,SAAhC,EAGGC,MAHH,CAGU,UAACC,WAAD,EAAcC,OAAd,EAA0B;AAClC,cAAMC,KAAK,GAAGhB,IAAI,CAACiB,WAAL,CAAiBhB,UAAjB,CAAd;AACA,cAAMiB,IAAI,GAAGV,IAAI,CAACC,GAAL,KAAaT,IAAI,CAACE,UAAL,CAAgBiB,YAA1C;;AACA,cAAInB,IAAI,CAACE,UAAL,CAAgBkB,aAAhB,GAAgCF,IAAI,IAAI,OAAO,EAAP,GAAY,EAAZ,GAAiB,EAArB,CAAJ,GAA+B,GAAnE,EAAwE;AACtE9B,YAAAA,MAAM,CAACY,IAAI,CAACE,UAAN,EAAkBc,KAAlB,CAAN;AACA7B,YAAAA,MAAM,CAACK,IAAP,CAAY6B,MAAZ,CACE;AAAEF,cAAAA,YAAY,EAAEX,IAAI,CAACC,GAAL;AAAhB,aADF,EAEE;AAAEH,cAAAA,KAAK,EAAE;AAAEK,gBAAAA,EAAE,EAAEX,IAAI,CAACE,UAAL,CAAgBS;AAAtB;AAAT,aAFF;AAIAG,YAAAA,WAAW,CAACQ,SAAZ,CAAsB;AAAEV,cAAAA,eAAe,EAAE;AAAnB,aAAtB;AACD;AACF,SAdD;AAeD,OAjBD;AAkBD,KAzBD;AA0BA;AACD,GA5BD;AA6BD,CA9BD;;AA+BAW,MAAM,CAACC,OAAP,GAAiBlC,SAAjB","sourcesContent":["const schedule = require('node-schedule');\nconst Models = require('../models/index.js');\nconst mailer = require('./mailer');\nconst id_generator = require('../custom_module/id_generator');\n\nconst scheduler = function () {\n  schedule.scheduleJob('0 * * * * *', () => {\n    Models.User.findAll({\n      include: [\n        {\n          model: Models.Group,\n        },\n      ],\n    }).then((users) => {\n      users.forEach((data) => {\n        const sondage_id = data.dataValues.group.dataValues.sondage_id;\n        Models.JourSondage.findOrCreate({ \n          where: { date_emmission: Date.now(), sondage_id: sondage_id },\n          defaults: { id: id_generator(), sondage_id: sondage_id, nombre_emission: 0 }, \n        }).spread((jourSondage, created) => {\n          const token = data.generateJwt(sondage_id);\n          const diff = Date.now() - data.dataValues.lastMailDate;\n          if (data.dataValues.mailIntensity < diff / (1000 * 60 * 60 * 24) + 0.4) {\n            mailer(data.dataValues, token);\n            Models.User.update(\n              { lastMailDate: Date.now() },\n              { where: { id: data.dataValues.id } },\n            );\n            jourSondage.increment({ nombre_emission: 1 });\n          }\n        });\n      });\n    });\n    /**/\n  });\n};\nmodule.exports = scheduler;\n"],"file":"timer.js"}