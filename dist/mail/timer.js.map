{"version":3,"sources":["../../mail/timer.js"],"names":["schedule","require","Models","mailer","scheduler","scheduleJob","console","log","Date","now","User","findAll","then","users","forEach","data","Sondage","sondage","sondage_id","Math","floor","random","length","dataValues","id","token","generateJwt","diff","lastMailDate","mailIntensity","lastName","update","where","module","exports"],"mappings":";;AAAA,IAAMA,QAAQ,GAAGC,OAAO,CAAC,eAAD,CAAxB;;AACA,IAAMC,MAAM,GAAGD,OAAO,CAAC,oBAAD,CAAtB;;AACA,IAAME,MAAM,GAAGF,OAAO,CAAC,UAAD,CAAtB;;AAEA,IAAMG,SAAS,GAAG,SAAZA,SAAY,GAAY;AAC5BJ,EAAAA,QAAQ,CAACK,WAAT,CAAqB,aAArB,EAAoC,YAAM;AACxCC,IAAAA,OAAO,CAACC,GAAR,CAAY,0BAAZ,EAAwCC,IAAI,CAACC,GAAL,EAAxC;AAEAP,IAAAA,MAAM,CAACQ,IAAP,CAAYC,OAAZ,GAAsBC,IAAtB,CAA2B,UAACC,KAAD,EAAW;AACpCA,MAAAA,KAAK,CAACC,OAAN,CAAc,UAACC,IAAD,EAAU;AACtBb,QAAAA,MAAM,CAACc,OAAP,CAAeL,OAAf,GAAyBC,IAAzB,CAA8B,UAACK,OAAD,EAAa;AACzC,cAAMC,UAAU,GAAGD,OAAO,CAACE,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,MAAL,KAAgBJ,OAAO,CAACK,MAAnC,CAAD,CAAP,CAAoDC,UAApD,CAA+DC,EAAlF;AACA,cAAMC,KAAK,GAAGV,IAAI,CAACW,WAAL,CAAiBR,UAAjB,CAAd;AACA,cAAMS,IAAI,GAAGnB,IAAI,CAACC,GAAL,KAAaM,IAAI,CAACQ,UAAL,CAAgBK,YAA1C;;AACA,cAAIb,IAAI,CAACQ,UAAL,CAAgBM,aAAhB,GAAgCF,IAAI,IAAI,OAAO,EAAP,GAAY,EAAZ,GAAiB,EAArB,CAAJ,GAA+B,GAAnE,EAAwE;AACtErB,YAAAA,OAAO,CAACC,GAAR,4BAAgCQ,IAAI,CAACQ,UAAL,CAAgBO,QAAhD;AACA3B,YAAAA,MAAM,CAACY,IAAI,CAACQ,UAAN,EAAkBE,KAAlB,CAAN;AACAvB,YAAAA,MAAM,CAACQ,IAAP,CAAYqB,MAAZ,CACE;AAAEH,cAAAA,YAAY,EAAEpB,IAAI,CAACC,GAAL;AAAhB,aADF,EAEE;AAAEuB,cAAAA,KAAK,EAAE;AAAER,gBAAAA,EAAE,EAAET,IAAI,CAACQ,UAAL,CAAgBC;AAAtB;AAAT,aAFF;AAKD;AACF,SAbD;AAcD,OAfD;AAgBD,KAjBD;AAmBA;AACD,GAvBD;AAwBD,CAzBD;;AA0BAS,MAAM,CAACC,OAAP,GAAiB9B,SAAjB","sourcesContent":["const schedule = require('node-schedule');\nconst Models = require('../models/index.js');\nconst mailer = require('./mailer');\n\nconst scheduler = function () {\n  schedule.scheduleJob('0 * * * * *', () => {\n    console.log(\"Trying to send mail at: \", Date.now());\n\n    Models.User.findAll().then((users) => {\n      users.forEach((data) => {\n        Models.Sondage.findAll().then((sondage) => {\n          const sondage_id = sondage[Math.floor(Math.random() * sondage.length)].dataValues.id;\n          const token = data.generateJwt(sondage_id);\n          const diff = Date.now() - data.dataValues.lastMailDate;\n          if (data.dataValues.mailIntensity < diff / (1000 * 60 * 60 * 24) + 0.4) {\n            console.log(`Sending mail to: ${data.dataValues.lastName}`);\n            mailer(data.dataValues, token);\n            Models.User.update(\n              { lastMailDate: Date.now() },\n              { where: { id: data.dataValues.id } },\n\n            );\n          }\n        });\n      });\n    });\n\n    /**/\n  });\n};\nmodule.exports = scheduler;\n"],"file":"timer.js"}