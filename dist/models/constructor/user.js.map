{"version":3,"sources":["../../../models/constructor/user.js"],"names":["Sequelize","require","crypto","jwt","id_generator","env","userConstructor","sequelize","User","define","id","type","STRING","allowNull","primaryKey","firstName","lastName","email","salt","hash","photo","lastMailDate","DATE","mailIntensity","INTEGER","timestamps","addUser","password","Promise","resolve","generatedID","randomBytes","toString","sync","then","create","pbkdf2Sync","Date","now","prototype","validPassword","generateJwt","sondage_id","expiry","setDate","getDate","user_token_expiry_time","sign","user_id","remplissage_id","exp","parseInt","getTime","user_token_secret_key","module","exports"],"mappings":"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","sourcesContent":["const Sequelize = require('sequelize');\nconst crypto = require('crypto');\nconst jwt = require('jsonwebtoken');\nconst id_generator = require('../../custom_module/id_generator');\nconst env = require(\"../../const\");\n\nconst userConstructor = function (sequelize) {\n  const User = sequelize.define('user', {\n    id: {\n      type: Sequelize.STRING,\n      allowNull: false,\n      primaryKey: true,\n    },\n    firstName: {\n      allowNull: false,\n      type: Sequelize.STRING,\n    },\n    lastName: {\n      allowNull: false,\n      type: Sequelize.STRING,\n    },\n    email: {\n      allowNull: false,\n      type: Sequelize.STRING,\n    },\n    salt: {\n      type: Sequelize.STRING,\n    },\n    hash: {\n      type: Sequelize.STRING,\n    },\n    photo: {\n      type: Sequelize.STRING,\n    },\n    lastMailDate: {\n      type: Sequelize.DATE,\n    },\n    mailIntensity: {\n      type: Sequelize.INTEGER,\n    },\n  }, {\n    timestamps: false,\n  });\n\n  // Class Methods\n  User.addUser = function (firstName, lastName, email, password, photo = './public/user/photo/default.jpg') {\n    return new Promise(function (resolve) {\n      const generatedID = id_generator();\n      const salt = crypto.randomBytes(16).toString('hex');\n      User.sync().then(() => {\n        User.create({\n          id: generatedID,\n          firstName,\n          lastName,\n          email,\n          salt,\n          hash: crypto.pbkdf2Sync(password, salt, 1000, 64, 'sha512').toString('hex'),\n          photo,\n          mailIntensity: 1,\n          lastMailDate: Date.now() - 86400000,\n        }).then(() => {\n          resolve();\n        });\n      });\n    });\n  };\n\n  // Instance methods\n  User.prototype.validPassword = function (password) {\n    const hash = crypto.pbkdf2Sync(password, this.salt, 1000, 64, 'sha512').toString('hex');\n    return this.hash === hash;\n  };\n\n  User.prototype.generateJwt = function (sondage_id) {\n    const expiry = new Date();\n    expiry.setDate(expiry.getDate() + env.user_token_expiry_time);\n    return jwt.sign({\n      user_id: this.id,\n      sondage_id: sondage_id,\n      remplissage_id: id_generator(),\n      firstName: this.firstName,\n      lastName: this.lastName,\n      exp: parseInt(expiry.getTime() / 1000, 10),\n    }, env.user_token_secret_key);\n  };\n  return User;\n};\n\nmodule.exports = userConstructor;\n"],"file":"user.js"}