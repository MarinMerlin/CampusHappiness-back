{"version":3,"sources":["../../routes/admin.js"],"names":["express","require","router","Router","bodyParser","use","json","urlencoded","extended","morgan","Models","req","res","next","url","isAuthenticated","status","message","user","auth","get","session","destroy","send","post","promises","body","userList","forEach","push","User","addUser","firstName","lastName","email","Promise","all","then","pseudo","password","console","log","findOne","where","id","getSondage","sondageList","createSondage","name","Sondage","update","current","sondage","dataValues","findById","getCommentairesJour","params","jour","comments","getStatistics","statisticTab","getStatisticsSpecific","sondageResult","module","exports"],"mappings":"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","sourcesContent":["const express = require('express');\n\nconst router = express.Router();\n\n\n// Le body Parser permet d'acceder aux variable envoyés dans le body\nconst bodyParser = require('body-parser');\n\nrouter.use(bodyParser.json());\nrouter.use(express.urlencoded({ extended: false }));\n\nconst morgan = require('morgan');\n\n// Récupère les models\nconst Models = require('../models/index');\n\nrouter.use(morgan('dev'));\n\nrouter.use((req, res, next) => {\n  if (req.url === '/login') {\n    next();\n  } else if (!req.isAuthenticated()) {\n    res.status(401).json({ message: 'Not logged in' });\n  } else if (req.user.auth !== 1) {\n    res.status(401).json({ message: 'Not authorized' });\n  } else {\n    next();\n  }\n});\n\n// --------- Routes protegées par token -------------\n\n// Un administrateur peut ajouter un autre administrateur :\n// Les attributs de l'admin sont dans le body de la requète\n// TODO : Prendre en compte le cas où il y a une erreure au cours de la création de l'admin'\n\n// Logout the session\n\nrouter.get('/logout', (req, res) => {\n  req.session.destroy();\n  res.send(\"User logged out\");\n});\n\n// Routes relatives a la gestion des admins et des users\n/* router.post('/createAdmin', (req, res) => {\n  console.log(`creating admin ${req.body.pseudo}`);\n  // On vérifie que les données minmums pour créer un utilisateur sont bien présentes\n  if (!req.body.pseudo || !req.body.mp) {\n    console.log(\"/!\\\\ ERROR : The body of the create admin request doesnt contain pseudo or mp !\");\n    res.status(400).send(\"Bad Request : The body of the create admin request doesnt contain pseudo or mp ! \");\n  } else {\n    Models.Admin.addAdmin(req.body.pseudo, req.body.mp, Date.now()).then(() => {\n      console.log(`Added admin: ${req.body.pseudo}`);\n      res.status(200).send(`Admin ${req.body.pseudo} created`);\n    });\n  }\n}); */\n\nrouter.post('/csvPost',\n  (req, res) => {\n    const promises = [];\n    req.body.userList.forEach((user) => {\n      promises.push(Models.User.addUser(user.firstName, user.lastName, user.email));\n    });\n    Promise.all(promises).then(res.status(200).json(\"User list added\"));\n  });\n\nrouter.post('/singlePost',\n  (req, res) => {\n    Models.User.addUser(\n      req.body.firstName, \n      req.body.lastName, \n      req.body.email, \n      req.body.pseudo,\n      req.body.password,\n      req.body.auth,\n    ).then(() => {\n      res.status(200).send(\"New user added\");\n      console.log(\"New user added: \", req.body.pseudo);\n    });\n  }); \n\n// Route relative à l'affichage et la creation de sondage\n\nrouter.get('/getSondage', (req, res) => {\n  Models.User.findOne({ where: { id: req.user.id } }).then((user) => {\n    user.getSondage().then((sondageList) => {\n      console.log(\"Sent all sondages to client\");\n      res.status(200).json(sondageList);\n    });\n  });\n});\n\n/* Survey object sent from the front to /postSondage\n  {\n    name: sondagename,\n    thematiqueList: [\n      {\n        name: thematiquename,\n        questionList: [\n          {\n            keyWord: motclef,\n            question: question,\n          },\n          { ... },\n        ]\n      },\n      { ... },\n    ]\n  }\n*/\nrouter.post('/postSondage', (req, res) => {\n  Models.User.findOne({ where: { id: req.user.id } }).then((user) => {\n    user.createSondage(req.body).then(() => {\n      console.log(\"New sondage created: \", req.body.name);\n      res.status(200).send(\"New sondage created\");\n    });\n  });\n});\n\nrouter.post('/changeNextSondage', (req, res) => {\n  if (!req.body) {\n    console.log(\"/!\\\\ ERROR : Inccorect body\");\n    res.status(400).send(\"Bad Request : The body doesnt contain next_sondage ! \");\n  } else {\n    Models.Sondage.update({ current: false }, { where: { current: true } }).then(() => {\n      Models.Sondage.update({ current: true }, { where: { id: req.body.id } }).then((sondage) => {\n        console.log(\"Changed the sondage to sondage: \", req.body.name);\n        res.status(200).json(sondage.dataValues);\n      });\n    });\n  }\n});\n\n// Route relative aux statisques\n\nrouter.get('/getCommentaireJour/:jour', (req, res) => {\n  Models.User.findById(req.user.id).then((user) => {\n    user.getCommentairesJour(req.params.jour).then((comments) => {\n      console.log(\"Fetching all Commentaires on: \", req.params.jour);\n      res.status(200).json(comments);\n    });\n  });\n});\n\nrouter.get(\"/generalStatistics\", (req, res) => {\n  Models.User.findById(req.user.id).then((user) => {\n    user.getStatistics((statisticTab) => {\n      res.json(statisticTab);\n    });\n  });\n});\n\nrouter.get(\"/specificStatistics/:year/:month/:day\", (req, res) => {\n  Models.User.findById(req.user.id).then((user) => {\n    user.getStatisticsSpecific(req.params).then((sondageResult) => {\n      res.json(sondageResult);\n    });\n  });\n});\n\nmodule.exports = router;"],"file":"admin.js"}