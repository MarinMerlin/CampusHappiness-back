{"version":3,"sources":["../../routes/user.js"],"names":["express","require","Models","userCheckToken","router","Router","get","req","res","user","sondage_id","remplissage_id","serverResponse","alreadyAnswered","Remplissage","findOne","where","id","then","remplissage","Question","findAll","include","model","Thematique","questions","questionList","thematiqueList","Map","forEach","question","quest","JSON","parse","stringify","thematique","console","log","dataValues","set","newList","push","elem","Reponse","reponses","reponseList","reponse","json","post","user_id","findById","send","msg","User","sondage","answered_questions","body","answered_commentaires","answerSondage","status","newIntensity","update","mailIntensity","module","exports"],"mappings":"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","sourcesContent":["const express = require('express');\nconst Models = require('../models/index');\nconst userCheckToken = require('../controllers/userCheckToken');\n\nconst router = express.Router();\n\n// front send un get avec header\nrouter.get('/getSondage',\n  userCheckToken,\n  (req, res) => {\n    const { sondage_id, remplissage_id } = req.user;\n    const serverResponse = { alreadyAnswered: false };\n    Models.Remplissage.findOne({ where: { id: remplissage_id } }).then((remplissage) => {\n      Models.Question.findAll({\n        include: [{\n          model: Models.Thematique,\n        }],\n        where: { sondage_id: sondage_id }, \n      }).then((questions) => {\n        const questionList = [];\n        const thematiqueList = new Map();\n        questions.forEach((question) => {\n          const quest = JSON.parse(JSON.stringify(question));\n          delete quest.thematique;\n          console.log(\"question    \", quest);\n          if (!thematiqueList.get(question.dataValues.thematique.dataValues.id)) {\n            thematiqueList.set(\n              question.dataValues.thematique.dataValues.id, \n              question.dataValues.thematique.dataValues,\n            );\n          }\n          const newList = thematiqueList.get(question.dataValues.thematique.dataValues.id);\n          if (newList.questionList) {\n            newList.questionList.push(quest);\n          } else {\n            newList.questionList = [quest];\n          }\n          console.log(\"plip    \", newList);\n          thematiqueList.set(question.dataValues.thematique.dataValues.id, newList); \n        });\n        thematiqueList.forEach((elem) => {\n          questionList.push(elem);\n        });\n        console.log(questionList);\n        serverResponse.thematiqueList = questionList; \n\n        // Si le sondage a déjà été remplis, on renvois les réponses\n        if (remplissage) {\n          serverResponse.alreadyAnswered = true;\n          Models.Reponse.findAll({ where: { remplissage_id: remplissage_id } }).then((reponses) => {\n            const reponseList = [];\n            reponses.forEach((reponse) => {\n              reponseList.push(reponse);\n            }); \n            serverResponse.reponseList = reponseList;\n            res.json(serverResponse);\n          }); \n        } else {\n          res.json(serverResponse);\n        }\n      }); \n    });\n  });\n\n\n// front send un post avec header et dans le body un answered_questions (cf index.js)\nrouter.post('/answerSondage',\n  userCheckToken,\n  (req, res) => {\n    const { user_id, sondage_id, remplissage_id } = req.user;\n    Models.Remplissage.findById(remplissage_id).then((remplissage) => {\n      if (remplissage) {\n        res.send({ msg: \"Vous aviez deja repondue au sondage...\" });\n      } else {\n        Models.User.findById(user_id).then((user) => {\n          const sondage = { \n            sondage_id: sondage_id,\n            remplissage_id: remplissage_id,\n            answered_questions: req.body.answered_questions,\n            answered_commentaires: req.body.answered_commentaires,\n          };\n          user.answerSondage(sondage);\n          res.status(200).send({ msg: \"merci d'avoir repondue :)\" });\n        });\n      }\n    });\n  });\n\nrouter.post('/changeFreq', userCheckToken, (req, res) => {\n  if (typeof (req.body.newIntensity) === \"number\") {\n    Models.User.update(\n      { mailIntensity: req.body.newIntensity },\n      { where: req.body.user_id },\n    ).then(res.send({ msg: \"Mail Intensity changed\" }));\n  }\n});\n\nmodule.exports = router;\n"],"file":"user.js"}